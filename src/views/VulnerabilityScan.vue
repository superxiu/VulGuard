<template>
  <!-- Task Details -->
  <template v-if="selectedTask">
    <TaskDetails :task="selectedTask" @back-to-list="selectedTask = null" />
  </template>
  <!-- Build Task -->
  <template v-else-if="isBuildNewTask">
    <BuildTask class="newTaskContent" @child-data="handleChildData" />
  </template>
  <!-- Default view -->
  <template v-else>
    <div class="task-list">
      <el-button type="primary" class="add-task-button" @click="buildNewTask">  
        <i class="bi-plus plus-icon"></i>
        新建扫描任务
      </el-button>
      <TableSkeleton :loading="isLoading" :rows="10">
        <el-table :data="paginatedData" class="task-table" style="width: 100%" @row-click="handleRowClick">
          <el-table-column prop="index" type="index" label="序号" width="130"></el-table-column>
          <el-table-column prop="name" label="名称" width="240"></el-table-column>
          <el-table-column prop="startTime" label="开始时间" width="280"></el-table-column>
          <el-table-column prop="status" label="状态" width="180">
            <template v-slot:default="scope">
              <el-tag :type="statusType(scope.row.status)">{{ scope.row.status }}</el-tag>
            </template>
          </el-table-column>
          <el-table-column label="操作" width="180">
            <template v-slot:default="scope">
              <i :class="getIconClass(scope.row.status)" @click.stop="togglePause(scope.row)" style="color: #409EFF; cursor: pointer; font-size: 10px;"></i>
              <i class="bi-trash-fill" @click.stop="confirmDelete(scope.$index, scope.row)" style="color: red; margin-left: 10px; cursor: pointer;"></i>
            </template>
          </el-table-column> 
        </el-table>
        <!-- Pagination -->
        <div class="pagination-container">
          <el-pagination
            size="small"
            layout="prev, pager, next"
            class="mt-4"
            :total="totalItems"
            :page-size="pageSize"
            @current-change="handlePageChange"
            :current-page="currentPage"
          />
        </div>
      </TableSkeleton>
    </div>
  </template>
</template>

<script setup>
import { ref, onMounted, watch, computed } from 'vue';
import TaskDetails from '../components/vulscan/TaskDetails.vue';
import { useTableData } from '../services/dataService';
import 'bootstrap-icons/font/bootstrap-icons.css';
import BuildTask from '../components/vulscan/buildTask.vue';
import { useUserStore } from '@/stores/userStore';
import axios from 'axios';
import { ElMessage, ElMessageBox } from 'element-plus';
import TableSkeleton from '@/components/loading/TableSkeleton.vue';

const apiUrl = import.meta.env.VITE_API_URL;
// 构建请求的完整URL
const init_url = `${apiUrl}/task/init_task`;
const delete_url = `${apiUrl}/task/delete_task`;

const { tableData, fetchTasks } = useTableData();
const userStore = useUserStore();
const selectedTask = ref(null);
const isLoading = ref(true);

// 是否新建扫描任务
const isBuildNewTask = ref(false);

// 新建扫描任务
const buildNewTask = () => {
  isBuildNewTask.value = true;
}
const emit = defineEmits(['child-data']);
const handleChildData = async (data) => {
  isBuildNewTask.value = data;
  emit('child-data', data);
  if (!data) {
    // 如果任务创建完成，重新加载任务列表
    isLoading.value = true;
    await fetchTasks();
    totalItems.value = tableData.value.length;
    isLoading.value = false;
  }
}

const statusType = (status) => {
  switch (status) {
    case '未开始':
    case null:
      return 'info';
    case '进行中':
      return 'primary';
    case '已暂停':
      return 'warning';
    case '已完成':
    case '已结束': 
      return 'success';
    default:
      return '';
  }
};

const getIconClass = (status) => {
  switch (status) {
    case '未开始':
      return 'bi-play-fill';
    case '进行中':
      return 'bi-pause-fill';
    case '已暂停':
      return "bi-square-fill";
    default:
      return '';
  }
};

const togglePause = async (row) => {
  try {
    let response;
    if (row.status === '未开始') {
      response = await axios.post(init_url, {
        taskname: row.name,
        userID: userStore.currentUser.userID
      });
      if (response.status === 200) {
        console.log('任务启动成功:', response.data);
        row.status = '进行中'; // 更新状态
        ElMessage.success('任务启动成功');
        await fetchTasks();//刷新任务列表
        row._key = Date.now();
      } else {
        console.error('任务启动失败:', response.data.message);
      }
    } else if (row.status === '进行中') {
      row.status = '已暂停';
      ElMessage.success('任务暂停成功');
    } else if (row.status === '已暂停') {
      row.status = '进行中';
      ElMessage.success('任务恢复成功');
    }
    // 触发视图更新
    row._key = Date.now();
  } catch (error) {
    console.error('请求错误:', error);
  }
};

const confirmDelete = (index, row) => {
  if (row.status === '进行中') {
    ElMessage.warning('请先暂停任务再进行删除操作');
    return;
  }
  ElMessageBox.confirm(
    '此操作将永久删除该任务, 是否继续?',
    '提示',
    {
      confirmButtonText: '确定',
      cancelButtonText: '取消',
      type: 'warning',
    }
  ).then(() => {
    handleDelete(index, row);
  }).catch(() => {
    ElMessage.info('已取消删除');
  });
};

const handleDelete = async (index, row) => {
  try {
    const response = await axios({
      method: 'delete',
      url: delete_url,
      headers: {
        'Content-Type': 'application/json',
      },
      data: {
        taskname: row.name,
        userID: userStore.currentUser.userID
      }
    });
    if (response.status === 200) {
      ElMessage.success('任务已删除');
      tableData.value.splice(index, 1); // 从前端删除任务
    } else {
      console.error('任务删除失败:', response.data.message);
    }
  } catch (error) {
    console.error('请求错误:', error);
  }
};

const handleRowClick = (row, column) => {
  if (column.label !== '操作') {
    selectedTask.value = row;
  }
};

// Pagination
const currentPage = ref(1);
const pageSize = ref(12);
const totalItems = ref(0);

const paginatedData = computed(() => {
  const start = (currentPage.value - 1) * pageSize.value;
  const end = start + pageSize.value;
  return tableData.value.slice(start, end);
});

const handlePageChange = (page) => {
  currentPage.value = page;
};

onMounted(async () => {
  try {
    if (userStore.currentUser && userStore.currentUser.userID) {
      await fetchTasks();
      sortTasksByCreateTime();
      totalItems.value = tableData.value.length;
      isLoading.value = false;
    } else {
      ElMessage.error('您尚未登录，请先登录。');
      isLoading.value = false;
    }
  } catch (error) {
    ElMessage.error('获取任务列表数据失败');
    console.error('Failed to load table data:', error);
    isLoading.value = false;
  }
});

watch(
  () => userStore.currentUser,
  async (newUser) => {
    if (newUser && newUser.userID) {
      isLoading.value = true;
      await fetchTasks();
      sortTasksByCreateTime();
      totalItems.value = tableData.value.length;
      isLoading.value = false;
    }
  },
  { immediate: true }
);

const sortTasksByCreateTime = () => {
  tableData.value.sort((a, b) => new Date(a.create_time) - new Date(b.create_time));
};
</script>

<style scoped>
.add-task-button {
  margin-bottom: 20px;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); /* 添加按钮阴影 */
}

.plus-icon {
  color: white;
  margin-right: 8px;
  font-size: 18px; /* 调整加号图标大小 */
}

.task-table {
  background-color: #ffffff;
  width: 87.3%;
  /* max-height: 78vh;
  overflow: scroll; */
}

.pause-icon {
  cursor: pointer;
}
.task-list{
  background-color: white;
  padding: 20px 45px; 
  border-radius: 5px;
  min-height: 90%;
  /* width: 87.3%; */
  /* box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);  */
}
.pagination-container{
  display: flex;
  justify-content: right;
  margin-top: 5px;
}
</style>
